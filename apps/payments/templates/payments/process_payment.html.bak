{% extends 'base.html' %}
{% load static %}

{% block title %}Process Payment | {{ order.customer_name }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .payment-method-card { /* Added for consistency */
        cursor: pointer;
        border: 2px solid #e9ecef;
        transition: all 0.2s ease-in-out;
    }
    .payment-method-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .payment-method-card.selected {
        border-color: #0d6efd; /* Bootstrap primary color */
        background-color: #e7f1ff; /* Light blueish background */
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .payment-method-card.selected .form-check-label,
    .payment-method-card.selected h5 {
        color: #0d6efd;
    }
    #mobilePaymentDetails {
        /* display: none; /* Initially hidden - JS will handle based on radio */
    }
    /* Ensure icons used are available or use Feather icons */
</style>
{% endblock %}

{% block content %}
<div id="content-wrapper-for-modal"> {# This wrapper is kept in case modal loading is re-enabled later #}

    <div class="container mt-4 mb-5 py-4">
        <div class="row justify-content-center">
            <div class="col-lg-9 col-md-10">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-primary text-white py-3">
                        <h2 class="mb-0 h4 text-center"><i data-feather="credit-card" class="me-2"></i>Process Payment for Order #{{ order.order_number }}</h2>
                    </div>
                    <div class="card-body p-lg-5 p-4">
                        <div class="mb-4 border-bottom pb-3">
                            <h5 class="mb-3 text-primary">Order Summary</h5>
                            <div class="row">
                                <div class="col-sm-6">
                                    <p class="mb-1"><strong>Customer:</strong> {{ order.customer_name }}</p>
                                    <p class="mb-1"><strong>Order ID:</strong> {{ order.id }}</p>
                                </div>
                                <div class="col-sm-6 text-sm-end">
                                    <p class="mb-1"><strong>Date:</strong> {{ order.created_at|date:"M d, Y, h:i A" }}</p>
                                    <p class="mb-1"><strong>Total Amount:</strong> <span class="fw-bold fs-5 text-success">GHS {{ order.total_price|stringformat:"0.2f" }}</span></p>
                                </div>
                            </div>
                        </div>

                        <form method="POST" id="mainPaymentProcessingForm">
                            {% csrf_token %}
                            <input type="hidden" name="amount" value="{{ order.total_price|stringformat:"0.2f" }}">
                            <input type="hidden" name="notes" value=""> 

                            <div class="form-group mb-4">
                                <h5 class="mb-3 text-primary">Select Payment Method</h5>
                                <div class="list-group">
                                    <label class="list-group-item list-group-item-action payment-method-card p-3 rounded mb-2" for="cashPaymentRadio">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <input class="form-check-input me-2" type="radio" name="payment_method" id="cashPaymentRadio" value="cash" checked>
                                                <strong class="mb-1 fs-5">Cash Payment</strong>
                                                <small class="d-block text-muted">Pay with cash upon delivery or pickup.</small>
                                            </div>
                                            <i data-feather="dollar-sign" class="text-success h1 mb-0"></i>
                                        </div>
                                    </label>
                                    <label class="list-group-item list-group-item-action payment-method-card p-3 rounded" for="mobilePaymentRadio">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <input class="form-check-input me-2" type="radio" name="payment_method" id="mobilePaymentRadio" value="mobile_money">
                                                <strong class="mb-1 fs-5">Mobile Money (Paystack)</strong>
                                                <small class="d-block text-muted">Pay securely using your mobile money account.</small>
                                            </div>
                                            <i data-feather="smartphone" class="text-info h1 mb-0"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div id="mobilePaymentDetails" class="mb-4 p-3 bg-light rounded border" style="display: none;">
                                <h5 class="mb-3 text-info"><i data-feather="smartphone" class="me-1"></i>Enter Mobile Money Number</h5>
                                <div class="form-group">
                                    <label for="mobile_number_input" class="form-label">Phone Number (e.g., 024XXXXXXX)</label>
                                    <input type="tel" class="form-control form-control-lg" id="mobile_number_input" name="mobile_number" placeholder="Enter your mobile money number">
                                    <small class="form-text text-muted">Ensure it's the number registered for mobile money.</small>
                                </div>
                            </div>
                            
                            <hr class="my-4">

                            <div class="d-grid gap-2 d-sm-flex justify-content-sm-end">
                                <a href="{% url 'orders:order_detail' order.id %}" class="btn btn-outline-secondary btn-lg">
                                    <i data-feather="arrow-left" class="me-1"></i>Cancel & Return to Order
                                </a>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i data-feather="check-circle" class="me-2"></i>Confirm and Process Payment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Success Modal (for process_payment.html page) -->
    <div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-labelledby="paymentSuccessModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title" id="paymentSuccessModalLabel"><i data-feather="check-circle" class="me-2"></i>Payment Successful!</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div class="mb-3"><i data-feather="thumbs-up" class="text-success" style="font-size: 3rem; width:3rem; height:3rem;"></i></div>
                    <p id="successModalMessage" class="lead mb-3">Your payment has been processed successfully.</p>
                    <div id="successModalDetails" class="card bg-light border-0 mx-auto my-3" style="max-width: 400px;"><div class="card-body p-3 text-start"></div></div>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <a href="#" id="successModalViewOrderBtn" class="btn btn-primary btn-lg"><i data-feather="eye" class="me-2"></i>View Order Details</a>
                    <button type="button" class="btn btn-outline-secondary btn-lg" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Failed Modal (for process_payment.html page) -->
    <div class="modal fade" id="paymentFailedModal" tabindex="-1" aria-labelledby="paymentFailedModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title" id="paymentFailedModalLabel"><i data-feather="x-circle" class="me-2"></i>Payment Failed</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div class="mb-3"><i data-feather="alert-triangle" class="text-danger" style="font-size: 3rem; width:3rem; height:3rem;"></i></div>
                    <p id="failedModalMessage" class="lead mb-3">Unfortunately, your payment could not be processed.</p>
                    <div id="failedModalDetails" class="alert alert-danger text-start"></div>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-warning btn-lg" id="failedModalTryAgainBtn" data-bs-dismiss="modal"><i data-feather="refresh-cw" class="me-2"></i>Try Again</button>
                    <button type="button" class="btn btn-outline-secondary btn-lg" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Paystack Iframe Modal (for process_payment.html page) -->
    <div class="modal fade" id="paystackModal" tabindex="-1" aria-labelledby="paystackModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow">
                <div class="modal-header">
                    <h5 class="modal-title" id="paystackModalLabel"><i data-feather="smartphone" class="me-2"></i>Complete Mobile Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="paystackModalCloseBtn"></button>
                </div>
                <div class="modal-body p-0" style="height: 75vh;"><iframe id="paystackIframe" src="about:blank" style="width: 100%; height: 100%; border: none;"></iframe></div>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // Helper to get Bootstrap Modal instance
        function getModalInstance(modalId) {
            var modalElement = document.getElementById(modalId);
            if (!modalElement) {
                console.error('Modal element ' + modalId + ' not found in loaded content.');
                return null;
            }
            return bootstrap.Modal.getOrCreateInstance(modalElement);
        }

        const cashRadio = $('#cashPaymentRadio');
        const mobileRadio = $('#mobilePaymentRadio');
        const mobilePaymentDetailsDiv = $('#mobilePaymentDetails');
        const mobileNumberActualInput = $('#mobile_number_input'); // Corrected ID

        function toggleMobileDetailsView() {
            if (mobileRadio.is(':checked')) {
                mobilePaymentDetailsDiv.slideDown();
                mobileNumberActualInput.prop('disabled', false);
            } else {
                mobilePaymentDetailsDiv.slideUp();
                mobileNumberActualInput.prop('disabled', true);
            }
        }

        // Initial state and listeners for radio buttons
        $('input[name="payment_method"]').on('change', toggleMobileDetailsView);
        toggleMobileDetailsView(); // Call on load

        // Style selected payment method card
        $('.payment-method-card').on('click', function() {
            $('.payment-method-card').removeClass('selected');
            $(this).addClass('selected');
            var radioInput = $(this).find('input[type="radio"]');
            if (!radioInput.is(':checked')) { // Only trigger change if not already checked
                radioInput.prop('checked', true).trigger('change');
            }
        });
         // Initialize selection based on checked radio
        $('input[name="payment_method"]:checked').closest('.payment-method-card').addClass('selected');


        $('#mainPaymentProcessingForm').on('submit', function(event) {
            event.preventDefault();
            var form = $(this);
            var url = form.attr('action') || window.location.pathname; 
            var submitButton = form.find('button[type="submit"]');
            var originalButtonHtml = submitButton.html(); // Store full HTML for icons

            var requestData = form.serialize();
            // mobile_number field name is now "mobile_number" directly in HTML, so serialize() handles it.
            
            submitButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');

            $.ajax({
                type: 'POST',
                url: url,
                data: requestData,
                dataType: 'json',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("X-CSRFToken", $('input[name="csrfmiddlewaretoken"]', form).val());
                    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                },
                success: function(response) {
                    var successModal = getModalInstance('paymentSuccessModal');
                    var failedModal = getModalInstance('paymentFailedModal');
                    var paystackModal = getModalInstance('paystackModal');

                    if (response.status === 'success') {
                        if (response.payment_method === 'mobile_money' && response.authorization_url) {
                            if(paystackModal) {
                                $('#paystackIframe').attr('src', response.authorization_url);
                                paystackModal.show();
                                const paystackCloseBtn = document.getElementById('paystackModalCloseBtn');
                                $(paystackCloseBtn).off('click').on('click', function() { // Use jQuery for consistency
                                    console.log('Paystack modal closed by user. Ref:', response.reference);
                                     // Show a generic success/pending message when Paystack modal is closed by user
                                    if(successModal) {
                                        $('#successModalMessage').text('Mobile payment initiated. Please confirm on your phone. Check order status for updates.');
                                        $('#successModalDetails .card-body').html(\`<p>Reference: \${response.reference}</p>\`);
                                        var orderDetailUrl = "{% url 'orders:order_detail' pk=0 %}".replace('0', response.order_id || '{{ order.id|default:0 }}');
                                        $('#successModalViewOrderBtn').attr('href', orderDetailUrl).text('View Order Status').show();
                                        successModal.show();
                                    }
                                });
                            }
                        } else if (response.payment_method === 'cash') {
                            if(successModal) {
                                $('#successModalMessage').text(response.message || 'Cash payment recorded successfully!');
                                var detailsHtml = \`
                                    <div class="d-flex justify-content-between mb-2"><span>Status:</span><span class="badge bg-success">\${response.payment_status || 'Completed'}</span></div>
                                    <div class="d-flex justify-content-between mb-2"><span>Amount:</span><span class="fw-bold">GHS \${response.amount}</span></div>
                                    <div class="d-flex justify-content-between mb-2"><span>Payment Method:</span><span>Cash</span></div>
                                    <div class="d-flex justify-content-between mb-2"><span>Order ID:</span><span>\${response.order_id}</span></div>
                                    \${response.payment_id ? \`<div class="d-flex justify-content-between"><span>Payment ID:</span><span><small>\${response.payment_id}</small></span></div>\` : ''}
                                \`;
                                $('#successModalDetails .card-body').html(detailsHtml);
                                var orderDetailUrl = "{% url 'orders:order_detail' pk=0 %}".replace('0', response.order_id || '{{ order.id|default:0 }}');
                                $('#successModalViewOrderBtn').attr('href', orderDetailUrl).text('View Order Details').show();
                                successModal.show();
                            }
                        } else {
                             if(successModal) {
                                $('#successModalMessage').text(response.message || 'Payment processed!');
                                $('#successModalDetails .card-body').html('<p>Details not available.</p>');
                                if (response.order_id) {
                                   var genericOrderDetailUrl = "{% url 'orders:order_detail' pk=0 %}".replace('0', response.order_id || '{{ order.id|default:0 }}');
                                   $('#successModalViewOrderBtn').attr('href', genericOrderDetailUrl).show();
                                } else { $('#successModalViewOrderBtn').hide(); }
                                successModal.show();
                             }
                        }
                    } else { 
                        if(failedModal) {
                            var errorMsg = 'Payment failed.';
                            if (response.message) { errorMsg = response.message; } 
                            else if (response.errors) { 
                                var errorsArray = [];
                                for (var field in response.errors) { errorsArray.push(field.replace("__all__", "Form") + ': ' + response.errors[field].join(', '));}
                                errorMsg = errorsArray.join('<br>');
                            }
                            $('#failedModalMessage').text('Payment Processing Error');
                            $('#failedModalDetails').html(errorMsg);
                            failedModal.show();
                        }
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    var failedModal = getModalInstance('paymentFailedModal');
                    if(failedModal) {
                        var errorMsg = 'An unexpected error occurred. Please check your network and try again.';
                        try { var errResp = JSON.parse(jqXHR.responseText); if(errResp && errResp.message) errorMsg = errResp.message; } catch(e){}
                        $('#failedModalMessage').text('Payment System Error');
                        $('#failedModalDetails').html(errorMsg + '<br><small>Status: ' + textStatus + ', Error: ' + errorThrown + '</small>');
                        failedModal.show();
                    }
                },
                complete: function() {
                    submitButton.prop('disabled', false).html(originalButtonHtml);
                    if (typeof feather !== 'undefined') feather.replace();
                }
            });
        });

        window.addEventListener('message', function(event) {
            const data = event.data;
            if (data && (data.status === 'success' || data.status === 'error') && typeof data.reference !== 'undefined') {
                var paystackModalInst = getModalInstance('paystackModal');
                var successModalInst = getModalInstance('paymentSuccessModal');
                var failedModalInst = getModalInstance('paymentFailedModal');

                if (paystackModalInst) paystackModalInst.hide();

                if (data.status === 'success') {
                    if(successModalInst) {
                        $('#successModalMessage').text(data.message || 'Mobile payment successful!');
                        var detailsHtml = \`
                            <div class="d-flex justify-content-between mb-2"><span>Status:</span><span class="badge bg-success">\${data.payment_status_display || 'Completed'}</span></div>
                            <div class="d-flex justify-content-between mb-2"><span>Amount:</span><span class="fw-bold">GHS \${data.amount}</span></div>
                            <div class="d-flex justify-content-between mb-2"><span>Payment Method:</span><span>Mobile Money</span></div>
                            <div class="d-flex justify-content-between mb-2"><span>Order ID:</span><span>\${data.order_id}</span></div>
                            <div class="d-flex justify-content-between mb-2"><span>Reference:</span><span><small>\${data.reference}</small></span></div>
                            \${data.payment_id ? \`<div class="d-flex justify-content-between"><span>Payment ID:</span><span><small>\${data.payment_id}</small></span></div>\` : ''}
                        \`;
                        $('#successModalDetails .card-body').html(detailsHtml);
                        var orderDetailUrl = "{% url 'orders:order_detail' pk=0 %}".replace('0', data.order_id || '{{ order.id|default:0 }}');
                        $('#successModalViewOrderBtn').attr('href', orderDetailUrl).show();
                        successModalInst.show();
                    }
                } else { 
                    if(failedModalInst) {
                        $('#failedModalMessage').text('Mobile Payment Failed');
                        $('#failedModalDetails').html(data.message || 'Your mobile payment could not be verified.');
                        failedModalInst.show();
                    }
                }
            }
        }, false);
        
        if (typeof feather !== 'undefined') feather.replace();
    });
    </script>

</div> {# End of content-wrapper-for-modal #}
{% endblock %}
```

**File to Revert (`order_detail.html`):**
`C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp\templates\orders\order_detail.html`

**Changes for `order_detail.html`:**
1.  Remove the entire "Payment Process Modal" HTML block (previously lines 351-371 after the last modifications).
2.  Remove the entire JavaScript block added for modal handling within `{% block extra_js %}` (previously lines 381-443). The `extra_js` block should revert to just `{{ block.super }}` or its original content if any.
3.  Change the "Pay Now" button (around line 288) back to a direct link, removing the `id="payNowBtn"`:
    *   From (current state, may vary slightly based on last edits):
        `<a href="{% url 'payments:process_payment' order.id %}" id="payNowBtn" class="btn btn-primary">...</a>`
    *   To (original state):
        `<a href="{% url 'payments:process_payment' order.id %}" class="btn btn-primary">...</a>`

**Reasoning:**
First, `process_payment.html` is restored to its complete, operational state, including all its necessary JavaScript and modals, all wrapped within `#content-wrapper-for-modal`. The mobile number input name is changed to `mobile_number` and `id` to `mobile_number_input` for cleaner handling in the script.
Second, `order_detail.html` is reverted: the modal for hosting the payment process is removed, the associated JavaScript is removed, and the "Pay Now" button becomes a simple hyperlink again, directing the user to the `process_payment.html` page as a separate navigation.
</task>
</code>
</action>context:
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T17:55:25.807441100Z"
- shell_name: pwsh
  shell_version: 5.1.22621.4391
- os_category: Windows
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T17:55:43.081849100Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:04:44.941632400Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:07:31.585625800Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:09:25.243337100Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:10:02.365276200Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:12:10.012859400Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:13:06.997975500Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:14:28.581458900Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:15:48.914064Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:18:00.562832800Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:24:06.543235Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:27:04.409805600Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:30:52.820124400Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:53:08.421344800Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:54:16.396734700Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T18:57:01.577245Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T19:09:13.666851800Z"
- pwd: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
  home_directory: C:\Users\ntibreymaximus
- current_time: "2025-05-29T19:09:57.405636200Z"
repo_path: C:\Users\ntibreymaximus\Desktop\Adakings\WebApps\RestaurantApp
