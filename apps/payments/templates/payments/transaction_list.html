{% extends "base.html" %}
{% load static %}

{% block title %}Payment Transactions | {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">

  <!-- Page Header -->
  <div class="page-header card shadow-sm mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-auto">
          <div class="page-icon-box">
            <i data-feather="list"></i>
          </div>
        </div>
        <div class="col">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
              <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}" class="text-decoration-none">Dashboard</a></li>
              <li class="breadcrumb-item active" aria-current="page">Payment Transactions</li>
            </ol>
          </nav>
          <h1 class="page-title h3 mb-0">Payment Transactions</h1>
          <p class="text-muted mb-0">View and manage all payment records.</p>
        </div>
        <!-- Optional: Add action button like "Export" if needed later -->
        <!-- <div class="col-auto ms-auto">
          <a href="#" class="btn btn-primary">Export Data</a>
        </div> -->
      </div>
    </div>
  </div>

  <!-- Filters Section - TODO: Implement filter form handling if needed -->
  <div class="mb-4"> <!-- Added mb-4 for spacing -->
    <form method="get" class="row g-3 align-items-center">
      <div class="col-md-3">
        <label for="q" class="form-label">Search</label>
        <input type="text" name="q" id="q" class="form-control form-control-sm" value="{{ request.GET.q|default:'' }}" placeholder="Order ID, Customer, Ref...">
      </div>
      <div class="col-md-2">
        <label for="payment_method" class="form-label">Method</label>
        <select name="payment_method" id="payment_method" class="form-select form-select-sm">
          <option value="">All</option>
          {% for value, display in payment_method_choices %}
          <option value="{{ value }}" {% if request.GET.payment_method == value %}selected{% endif %}>{{ display }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="status" class="form-label">Status</label>
        <select name="status" id="status" class="form-select form-select-sm">
          <option value="">All</option>
          {% for value, display in status_choices %}
          <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ display }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="start_date" class="form-label">Start Date</label>
        <input type="date" name="start_date" id="start_date" class="form-control form-control-sm" value="{{ request.GET.start_date|default:'' }}">
      </div>
      <div class="col-md-2">
        <label for="end_date" class="form-label">End Date</label>
        <input type="date" name="end_date" id="end_date" class="form-control form-control-sm" value="{{ request.GET.end_date|default:'' }}">
      </div>
      <div class="col-md-1 align-self-end">
        <button type="submit" class="btn btn-primary btn-sm w-100"><i data-feather="filter" class="me-1"></i>Filter</button>
      </div>
    </form>
  </div>

  <!-- Transactions Table -->
  <div class="card shadow-sm">
    <div class="card-header">
      <i data-feather="dollar-sign" class="me-2"></i>All Transactions
      <span class="badge bg-secondary float-end mt-1">Total: {{ transactions.paginator.count|default:0 }}</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>ID / Reference</th>
              <th>Order</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Status</th>
              <th>Type</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in transactions %}
            <tr>
              <td>
                <a href="{% url 'payments:transaction_detail' transaction.pk %}">
                  {{ transaction.reference|truncatechars:15 }}
                </a>
                {% if transaction.paystack_reference %}
                  <small class="d-block text-muted">PS Ref: {{ transaction.paystack_reference|truncatechars:10 }}</small>
                {% endif %}
              </td>
              <td>
                {% if transaction.order %}
                  <a href="{% url 'orders:order_detail' transaction.order.order_number %}">#{{ transaction.order.order_number }}</a>
                  <small class="d-block text-muted">{{ transaction.order.customer_name|default:"N/A" }}</small>
                  <small class="d-block text-danger">DEBUG PK: {{ transaction.order.pk }}</small> {# <-- ADD THIS LINE FOR DEBUGGING #}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>â‚µ{{ transaction.amount|floatformat:2 }}</td>
              <td>{{ transaction.get_payment_method_display }}</td>
              <td><span class="badge bg-{{ transaction.get_status_badge_class }}">{{ transaction.get_status_display }}</span></td>
              <td>{{ transaction.get_payment_type_display }}</td>
              <td>{{ transaction.created_at|date:"M d, Y H:i" }}</td>
              <td>
                <a href="{% url 'payments:transaction_detail' transaction.pk %}" class="btn btn-sm btn-info" title="View Details">
                  <i data-feather="eye"></i>
                </a>
                <!-- Add more actions if needed, e.g., refund button -->
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-4">No transactions found matching your criteria.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% if transactions.has_other_pages %}
    <div class="card-footer">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-0">
          {% if transactions.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo; First</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ transactions.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {% for i in transactions.paginator.page_range %}
            {% if transactions.number == i %}
              <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
            {% elif i > transactions.number|add:'-3' and i < transactions.number|add:'3' %}
              <li class="page-item"><a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a></li>
            {% endif %}
          {% endfor %}

          {% if transactions.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ transactions.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ transactions.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Last &raquo;</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  // Specific JS for this page if needed in the future
  // For example, initializing date pickers or interactive filter elements.
</script>
{% endblock %}

