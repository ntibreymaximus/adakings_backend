{% extends "payments/base_payments.html" %}

{% block title %}Transaction History - Restaurant Management System{% endblock %}

{% block extra_css %}
<style>
  .stats-card {
    transition: all 0.3s ease;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }
  
  .filter-card {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  
  .table-container {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .payment-status {
    padding: 0.25rem 0.5rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .status-pending {
    background-color: #fff3cd;
    color: #856404;
  }
  
  .status-completed {
    background-color: #d4edda;
    color: #155724;
  }
  
  .status-failed {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .status-processing {
    background-color: #cce5ff;
    color: #004085;
  }
</style>
{% endblock %}

{% block payment_content %}
<h1 class="mb-4">Transaction History</h1>
<div class="card filter-card">
  <div class="card-header bg-white">
    <h5 class="mb-0">Filter Transactions</h5>
  </div>
  <div class="card-body">
    <form method="get" id="filter-form" class="row g-3">
      <!-- Search input -->
      <div class="col-md-3">
        <label for="q" class="form-label">Search</label>
        <div class="input-group">
          <input type="text" class="form-control" id="q" name="q" placeholder="Order ID, customer name..." value="{{ current_filters.q }}">
          <button class="btn btn-outline-primary" type="submit">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
      
      <!-- Payment Method filter -->
      <div class="col-md-3">
        <label for="payment_method" class="form-label">Payment Method</label>
        <select class="form-select" id="payment_method" name="payment_method">
          <option value="">All Methods</option>
          {% for value, label in payment_method_choices %}
          <option value="{{ value }}" {% if current_filters.payment_method == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Status filter -->
      <div class="col-md-3">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" id="status" name="status">
          <option value="">All Statuses</option>
          {% for value, label in status_choices %}
          <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Date range filter -->
      <div class="col-md-3">
        <label for="start_date" class="form-label">Start Date</label>
        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ current_filters.start_date }}">
      </div>
      
      <div class="col-md-3">
        <label for="end_date" class="form-label">End Date</label>
        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ current_filters.end_date }}">
      </div>
      
      <!-- Filter buttons -->
      <div class="col-md-6 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">
          <i class="fas fa-filter"></i> Apply Filters
        </button>
        <a href="{% url 'payments:transaction_list' %}" class="btn btn-outline-secondary">
          <i class="fas fa-undo"></i> Reset
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Transaction Statistics -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="stats-card card bg-primary text-white h-100">
      <div class="card-body">
        <h5 class="card-title">Total Transactions</h5>
        <h2 class="display-4">{{ transaction_counts.total }}</h2>
        <p class="card-text"><i class="fas fa-exchange-alt"></i> All transactions</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="stats-card card bg-success text-white h-100">
      <div class="card-body">
        <h5 class="card-title">Total Revenue</h5>
        <h2 class="display-4">₵{{ total_amount|floatformat:2 }}</h2>
        <p class="card-text"><i class="fas fa-money-bill-wave"></i> From {{ transaction_counts.completed }} completed payments</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="stats-card card bg-warning h-100">
      <div class="card-body">
        <h5 class="card-title">Pending</h5>
        <h2 class="display-4">{{ transaction_counts.pending }}</h2>
        <p class="card-text"><i class="fas fa-clock"></i> Pending transactions</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3 mb-3">
    <div class="stats-card card bg-danger text-white h-100">
      <div class="card-body">
        <h5 class="card-title">Failed</h5>
        <h2 class="display-4">{{ transaction_counts.failed }}</h2>
        <p class="card-text"><i class="fas fa-times-circle"></i> Failed transactions</p>
      </div>
    </div>
  </div>
</div>

<!-- Transactions Table -->
<div class="card table-container">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Transaction List</h5>
    <span class="text-muted">{{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ paginator.count }} transactions</span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Order</th>
            <th class="d-none d-lg-table-cell">Customer</th>
            <th>Amount</th>
            <th class="d-none d-md-table-cell">Payment Method</th>
            <th class="d-none d-sm-table-cell">Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in transactions %}
          <tr>
            <td>{{ transaction.id }}</td>
            <td>#{{ transaction.order.id }}</td>
            <td class="d-none d-lg-table-cell">{{ transaction.order.customer_name }}</td>
            <td>₵{{ transaction.amount|floatformat:2 }}</td>
            <td class="d-none d-md-table-cell">
              {% if transaction.payment_method == 'cash' %}
              <span><i class="fas fa-money-bill-wave text-success me-1"></i> Cash</span>
              {% else %}
              <span><i class="fas fa-mobile-alt text-primary me-1"></i> Mobile Money</span>
              {% endif %}
            </td>
            <td class="d-none d-sm-table-cell">{{ transaction.created_at|date:"M d, Y H:i" }}</td>
            <td>
              {% if transaction.status == 'completed' %}
              <span class="payment-status status-completed">Completed</span>
              {% elif transaction.status == 'pending' %}
              <span class="payment-status status-pending">Pending</span>
              {% elif transaction.status == 'failed' %}
              <span class="payment-status status-failed">Failed</span>
              {% else %}
              <span class="payment-status status-processing">Processing</span>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'payments:transaction_detail' transaction.id %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-eye"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-4">No transactions found matching the filter criteria</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Pagination -->
  {% if is_paginated %}
  <div class="card-footer bg-white">
    <nav aria-label="Transaction pagination">
      <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" aria-label="First">
            <span aria-hidden="true">&laquo;&laquo;</span>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <a class="page-link" href="#" aria-label="First">
            <span aria-hidden="true">&laquo;&laquo;</span>
          </a>
        </li>
        <li class="page-item disabled">
          <a class="page-link" href="#" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        {% endif %}
        
        {% for num in paginator.page_range %}
          {% if page_obj.number == num %}
          <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
          </li>
          {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ paginator.num_pages }}" aria-label="Last">
            <span aria-hidden="true">&raquo;&raquo;</span>
          </a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <a class="page-link" href="#" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
        <li class="page-item disabled">
          <a class="page-link" href="#" aria-label="Last">
            <span aria-hidden="true">&raquo;&raquo;</span>
          </a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
{% endblock payment_content %}

{% block extra_js %}
<script>
  // Auto-submit form when select inputs change
  document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const selectInputs = filterForm.querySelectorAll('select');
    
    selectInputs.forEach(function(select) {
      select.addEventListener('change', function() {
        filterForm.submit();
      });
    });
    
    // Add event listeners to date inputs
    const dateInputs = filterForm.querySelectorAll('input[type="date"]');
    dateInputs.forEach(function(dateInput) {
      dateInput.addEventListener('change', function() {
        // Only submit if both date fields have values or both are empty
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if ((startDate && endDate) || (!startDate && !endDate)) {
          filterForm.submit();
        }
      });
    });
  });
</script>
{% endblock %}

