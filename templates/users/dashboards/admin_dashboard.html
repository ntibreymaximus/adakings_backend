{% extends "base.html" %}
{% block title %}Admin Dashboard | Restaurant Management System{% endblock %}

{% block extra_css %}
{# Styles removed, now using static/css/theme.css and Bootstrap #}
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">

<!-- Page Header -->
<div class="page-header card shadow-sm">
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-auto">
        <div class="page-icon-box">
          <i data-feather="activity"></i>
        </div>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}" class="text-decoration-none">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Admin</li>
          </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="page-title h3 mb-0">Admin Dashboard</h1>
            <p class="text-muted mb-0">Monitor system activities and staff performance</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stats-card bg-primary text-white">
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon">
          <i data-feather="shield"></i>
        </div>
        <div class="ms-3">
          <h3 class="mb-0">{{ admin_count|default:"0" }}</h3>
          <div class="text-white-50">Administrators</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stats-card bg-success text-white">
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon">
          <i data-feather="bell"></i>
        </div>
        <div class="ms-3">
          <h3 class="mb-0">{{ frontdesk_count|default:"0" }}</h3>
          <div class="text-white-50">Frontdesk Staff</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stats-card bg-warning"> {# text-dark is default for bg-warning in Bootstrap #}
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon"> {# theme.css handles icon color for bg-warning #}
          <i data-feather="coffee"></i>
        </div>
        <div class="ms-3">
          <h3 class="mb-0">{{ kitchen_count|default:"0" }}</h3>
          <div>Kitchen Staff</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stats-card bg-info text-white">
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon">
          <i data-feather="truck"></i>
        </div>
        <div class="ms-3">
          <h3 class="mb-0">{{ delivery_count|default:"0" }}</h3>
          <div class="text-white-50">Delivery Staff</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stats-card bg-info text-white">
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon">
          <i data-feather="shopping-cart"></i>
        </div>
        <div class="ms-3">
          <h3 class="mb-0">{{ today_orders|default:"0" }}</h3>
          <div class="text-white-50">Orders Today</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stats-card bg-success text-white">
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon">
          <i data-feather="dollar-sign"></i>
        </div>
        <div class="ms-3">
          <h3 class="mb-0">₵{{ revenue_today|default:"0.00" }}</h3>
          <div class="text-white-50">Revenue Today</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main content row for charts and tables -->
<div class="row">

  <!-- Recent Orders -->
  <div class="col-xl-6 col-lg-12 mb-4">
    <div class="card action-card"> {# Added action-card #}
      <div class="card-header">
        <i data-feather="list" class="me-2"></i>Recent Orders
      </div>
      <div class="card-body p-0"> {# Added p-0 #}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0"> {# Added align-middle mb-0 #}
            <thead class="table-light"> {# Added table-light #}
              <tr>
                <th class="ps-3">Order ID</th> {# Added ps-3 #}
                <th>Customer</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th class="text-end pe-3">Date</th> {# Added text-end pe-3 #}
              </tr>
            </thead>
            <tbody>
              {% for order in recent_orders %}
              <tr>
                <td class="ps-3"><a href="{% url 'orders:order_detail' order.order_number %}">{{ order.order_number }}</a></td> {# Added ps-3 #}
                <td>{{ order.customer_name|default:"N/A" }}</td>
                <td>{{ order.item_count|default:"N/A" }}</td>
                <td>₵{{ order.total|default:"0.00" }}</td>
                <td><span class="badge bg-{{ order.get_status_badge_class }}">{{ order.get_status_display }}</span></td>
                <td class="text-end pe-3">{{ order.created_at|date:"M d, Y H:i" }}</td> {# Added text-end pe-3 #}
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center">No recent orders found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer text-end">
        <a href="{% url 'orders:order_list' %}" class="btn btn-sm btn-primary">View All Orders</a>
      </div>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="col-xl-6 col-lg-12 mb-4">
    <div class="card action-card"> {# Added action-card #}
      <div class="card-header">
        <i data-feather="credit-card" class="me-2"></i>Recent Payments
      </div>
      <div class="card-body p-0"> {# Added p-0 #}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0"> {# Added align-middle mb-0 #}
            <thead class="table-light"> {# Added table-light #}
              <tr>
                <th class="ps-3">Payment ID</th> {# Added ps-3 #}
                <th>Order ID</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Status</th>
                <th class="text-end pe-3">Date</th> {# Added text-end pe-3 #}
              </tr>
            </thead>
            <tbody>
              {% for payment in recent_transactions %}
              <tr>
                <td class="ps-3"><a href="{% url 'payments:transaction_detail' payment.pk %}">{{ payment.reference|truncatechars:15 }}</a></td> {# Added ps-3 #}
                <td><a href="{% if payment.order %}{% url 'orders:order_detail' payment.order.order_number %}{% else %}#{% endif %}">{{ payment.order.order_number }}</a></td>
                <td>₵{{ payment.amount|default:"0.00" }}</td>
                <td>{{ payment.get_payment_method_display }}</td>
                <td><span class="badge bg-{{ payment.get_status_badge_class }}">{{ payment.get_status_display }}</span></td>
                <td class="text-end pe-3">{{ payment.timestamp|date:"M d, Y H:i" }}</td> {# Added text-end pe-3 #}
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center">No recent payments found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer text-end">
        <a href="{{ transaction_list_url|default:"#" }}" class="btn btn-sm btn-primary">View All Payments</a>
      </div>
    </div>
  </div>

</div>

<div class="row">
  <!-- Order Trends Chart -->
  <div class="col-xl-8 col-lg-7 mb-4">
    <div class="card">
      <div class="card-header">
        <i data-feather="bar-chart-2" class="me-2"></i>Order Trends (Last 14 Days)
      </div>
      <div class="card-body">
        <canvas id="orderTrendsChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Top Selling Items -->
  <div class="col-xl-4 col-lg-5 mb-4">
    <div class="card">
      <div class="card-header">
        <i data-feather="star" class="me-2"></i>Top Selling Items
      </div>
      <div class="card-body">
        {% if top_selling_items %}
        <ul class="list-group list-group-flush">
          {% for item in top_selling_items %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ item.name }}</strong>
              <small class="d-block text-muted">{{ item.item_type }}</small>
            </div>
            <span class="badge bg-primary rounded-pill">{{ item.order_count }} orders</span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-center">No sales data available for top items.</p>
        {% endif %}
      </div>
       <div class="card-footer text-end">
        <a href="#" class="btn btn-sm btn-secondary">View Full Menu (URL to be fixed)</a>
      </div>
    </div>
  </div>
</div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }} {# In case base.html has an extra_js block #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Order Trends Chart
    var ctxOrderTrends = document.getElementById('orderTrendsChart');
    if (ctxOrderTrends) {
      ctxOrderTrends = ctxOrderTrends.getContext('2d');
      new Chart(ctxOrderTrends, {
        type: 'line',
        data: {
          labels: {{ order_dates|safe }}, // From view context
          datasets: [{
            label: 'Orders per Day',
            data: {{ order_counts|safe }}, // From view context
            borderColor: 'rgba(0, 123, 255, 1)',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1 // Ensure y-axis shows whole numbers for counts
              }
            }
          }
        }
      });
    }
  });
</script>
{% endblock extra_js %}
