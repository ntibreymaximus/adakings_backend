{% extends "orders/base.html" %} {% block orders_content %}
<!-- Page Header -->
<div class="page-header card shadow-sm">
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-auto">
        <div class="page-icon-box">
          <i data-feather="clipboard"></i>
        </div>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item">
              <a href="{% url 'users:dashboard' %}" class="text-decoration-none"
                >Dashboard</a
              >
            </li>
            <li class="breadcrumb-item active" aria-current="page">Orders</li>
          </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="page-title h3 mb-0">Order Management</h1>
            <p class="text-muted mb-0">Track and manage restaurant orders</p>
            <p class="text-muted mt-1 small">Showing orders for: {{ display_date_header }}</p>
          </div>
          <div class="page-actions">
            <!-- New Order button moved to floating action button -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Combined Filter Form -->
<form method="get" class="row g-3 align-items-end my-4">
    <!-- Date Input Group -->
    <div class="col-md-4">
        {# Label removed as per request #}
        <input type="date" name="date" id="date_filter" class="form-control" value="{{ selected_date_for_picker }}" title="Select date to view orders">
    </div>

    <!-- Search Input Group -->
    <div class="col-md-5">
        <label for="search" class="form-label visually-hidden">Search Orders</label>
        <div class="input-group">
            <span class="input-group-text"><i data-feather="search"></i></span>
            <input type="text" name="search" id="search" class="form-control" placeholder="Search by customer, phone, or Order #" value="{{ search_query }}" title="Enter search term">
        </div>
    </div>

    <!-- Action Buttons Group -->
    <div class="col-md-3">
        <div class="form-group d-flex gap-2 w-100">
            <button type="submit" class="btn btn-primary flex-grow-1">
                <i data-feather="filter" class="me-1"></i> Apply Filters
            </button>
            <a href="{% url 'orders:order_list' %}" class="btn btn-secondary" title="Reset all filters">
                <i data-feather="rotate-ccw"></i> Reset
            </a>
        </div>
    </div>
</form>

<!-- Order List -->
{% if orders %}
<div class="card action-card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="ps-3">Order #</th>
            <th>Customer</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Delivery</th>
            <th>Price</th>
            <th class="text-end pe-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr>
            <td class="ps-3">
              <strong class="order-number">{{ order.order_number }}</strong>
            </td>
            <td>
              <div class="customer-name">{{ order.customer_name }}</div>
              <div class="customer-phone">{{ order.customer_phone }}</div>
            </td>
            <td>
              {% if order.status == "Pending" %}
              <span class="badge status-pending py-2 px-3"
                >{{ order.status }}</span
              >
              {% elif order.status == "Accepted" %}
              <span class="badge status-confirmed py-2 px-3"
                >{{ order.status }}</span
              >
              {% elif order.status == "Ready" %}
              <span class="badge status-ready py-2 px-3"
                >{{ order.status }}</span
              >
              {% elif order.status == "Out for Delivery" %}
              <span class="badge status-processing py-2 px-3"
                >{{ order.status }}</span
              >
              {% elif order.status == "Fulfilled" %}
              <span class="badge status-delivered py-2 px-3"
                >{{ order.status }}</span
              >
              {% elif order.status == "Cancelled" %}
              <span class="badge status-cancelled py-2 px-3"
                >{{ order.status }}</span
              >
              {% else %}
              <span class="badge bg-secondary py-2 px-3"
                >{{ order.status }}</span
              >
              {# Fallback #} {% endif %}
            </td>
            <td>
              {% if order.is_paid %}
              <span class="badge bg-success py-2 px-3">PAID</span>
              {% else %}
              <span class="badge bg-danger py-2 px-3">UNPAID</span>
              {% endif %}
            </td>
            <td>
              {% if order.delivery_type == "Pickup" %}
              <span class="badge bg-secondary py-2 px-3">Pickup</span>
              {% elif order.delivery_type == "Delivery" %}
              <span class="badge bg-info py-2 px-3"
                >{{ order.delivery_location|default:"Delivery" }}</span
              >
              {% else %}
              <span class="badge bg-light text-dark py-2 px-3"
                >{{ order.delivery_type }}</span
              >
              {# Fallback for unexpected types #} {% endif %}
            </td>
            <td class="price-display">₵{{ order.total_price }}</td>
            <td class="text-end pe-3">
              <div class="btn-group">
                
                <a
                  href="{% url 'orders:order_detail' order.order_number %}"
                  class="btn btn-sm btn-primary view-order-items-btn"
                  title="{% if order.delivery_type == "Delivery" %}Order {{ order.order_number }} - Delivery to {{ order.delivery_location }}: ₵{{ order.delivery_fee|floatformat:2 }}{% elif order.delivery_type == "Pickup" %}Order {{ order.order_number }} - Pickup (No Delivery Fee){% else %}Order {{ order.order_number }}{% endif %}"
                  data-order-number="{{ order.order_number }}"
                  data-bs-placement="left"
                  data-bs-html="true"
                  data-bs-content="<div class='text-center p-2'><div class='spinner-border spinner-border-sm' role='status'><span class='visually-hidden'>Loading...</span></div></div>"
                >
                  <i data-feather="eye"></i>
                </a>
                <a
                  href="{% url 'orders:order_update' order.order_number %}"
                  class="btn btn-sm btn-secondary"
                  title="Edit Order"
                >
                  <i data-feather="edit"></i>
                </a>
                <button
                  type="button"
                  class="btn btn-sm btn-warning update-status-btn-list"
                  title="Update Status"
                  data-bs-toggle="modal"
                  data-bs-target="#updateStatusModalList"
                  data-order-pk="{{ order.pk }}"
                  data-order-number="{{ order.order_number }}"
                  data-current-status="{{ order.status }}"
                  data-delivery-type="{{ order.delivery_type }}"
                >
                  <i data-feather="check-square"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ... [pagination section remains the same] ... -->
{% else %}
<div class="alert alert-info">
  <i data-feather="info" class="me-2"></i>No orders found.
</div>
{% endif %}

<!-- Update Status Modal (List Page) -->
<div class="modal fade" id="updateStatusModalList" tabindex="-1" aria-labelledby="updateStatusModalListLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="updateStatusFormList">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="updateStatusModalListLabel">Update Order Status for #<span id="modalOrderNumberSpanList"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="statusUpdateErrorAlertList" class="alert alert-danger d-none" role="alert"></div>
                    <input type="hidden" id="modalOrderPkInputList" name="order_pk">
                    <div class="mb-3">
                        <label for="newStatusSelectList" class="form-label">New Status</label>
                        <select class="form-select" id="newStatusSelectList" name="status" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" id="submitStatusUpdateBtnList">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock orders_content %} {% block extra_js %} {{ block.super }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const viewButtons = document.querySelectorAll(".view-order-items-btn");
    const baseUrlForItemsJson = "/orders/0/items_json/";
    let currentButtonHovered = null; // To manage hover state

    viewButtons.forEach((button) => {
      // Initial minimal popover config. Content will be set dynamically.
      // We removed data-bs-toggle="popover" from HTML and control it all via JS.
      // The button's initial data-bs-content is just for the "Loading..." state.

      button.addEventListener("mouseenter", async function () {
        currentButtonHovered = button;
        const orderNumber = this.dataset.orderNumber;
        const url = baseUrlForItemsJson.replace("0", orderNumber);

        // Dispose of any existing popover on this button to ensure a fresh start
        let existingPopover = bootstrap.Popover.getInstance(this);
        if (existingPopover) {
          existingPopover.dispose();
        }

        // Set to "Loading..." initially by resetting attribute
        this.setAttribute(
          "data-bs-content",
          "<div class='text-center p-2'><div class='spinner-border spinner-border-sm' role='status'><span class='visually-hidden'>Loading...</span></div></div>"
        );

        // Create a new popover instance with current button state (which includes the loading content)
        let popover = new bootstrap.Popover(this, {
          sanitize: false,
          html: true, // Ensure html is true here as well
          trigger: "manual", // We manually show/hide
          placement: this.dataset.bsPlacement || "left",
        });
        popover.show();

        try {
          const response = await fetch(url);

          if (!response.ok) {
            const errorText = await response.text();
            console.error(
              `HTTP error! status: ${response.status}, response text: ${errorText}`
            );
            this.setAttribute(
              "data-bs-content",
              `<p class="text-danger mb-0 text-center p-2">Error: ${response.status}</p>`
            );
          } else {
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              const responseText = await response.text();
              console.error(
                "Not JSON! Content-Type:",
                contentType,
                "Response Text:",
                responseText
              );
              this.setAttribute(
                "data-bs-content",
                '<p class="text-danger mb-0 text-center p-2">Error: Invalid data.</p>'
              );
            } else {
              const data = await response.json();

              let popoverContentHtml =
                '<div class="order-items-popover" style="min-width: 280px; max-width:350px;">';
              if (data && data.items && data.items.length > 0) {
                popoverContentHtml += '<ul class="list-unstyled mb-0">';
                data.items.forEach((item) => {
                  popoverContentHtml += `<li class="mb-2 pb-1 border-bottom">`;
                  popoverContentHtml += `<div><strong>${item.menu_item_name}</strong> (x${item.quantity})</div>`;
                  popoverContentHtml += `<div class="text-muted small">Price: ₵${item.unit_price} | Subtotal: ₵${item.subtotal}</div>`;
                  if (item.notes) {
                    popoverContentHtml += `<div class="text-info small fst-italic">Notes: ${item.notes}</div>`;
                  }
                  if (item.extras && item.extras.length > 0) {
                    popoverContentHtml +=
                      '<ul class="list-unstyled ms-3 mt-1 pt-1 border-top">';
                    item.extras.forEach((extra) => {
                      popoverContentHtml += `<li class="mb-1">`;
                      popoverContentHtml += `<div class="small"><i data-feather="corner-down-right" class="feather-sm me-1"></i>${extra.menu_item_name} (x${extra.quantity})</div>`;
                      popoverContentHtml += `<div class="text-muted small ps-3">Price: ₵${extra.unit_price} | Sub: ₵${extra.subtotal}</div>`;
                      if (extra.notes) {
                        popoverContentHtml += `<div class="text-info small fst-italic ps-3">Notes: ${extra.notes}</div>`;
                      }
                      popoverContentHtml += "</li>";
                    });
                    popoverContentHtml += "</ul>";
                  }
                  popoverContentHtml += "</li>";
                });
                popoverContentHtml += "</ul>";
              } else {
                popoverContentHtml +=
                  '<p class="mb-0 text-muted text-center py-2">No items or malformed data.</p>';
              }
              popoverContentHtml += "</div>";
              this.setAttribute("data-bs-content", popoverContentHtml);
            }
          }
        } catch (error) {
          console.error("Overall error in mouseenter (new approach):", error);
          this.setAttribute(
            "data-bs-content",
            '<p class="text-danger mb-0 text-center p-2">Failed to display items.</p>'
          );
        }

        // After updating attribute, dispose old and create new popover, then show
        let finalPopover = bootstrap.Popover.getInstance(this);
        if (finalPopover) {
          finalPopover.dispose();
        }
        finalPopover = new bootstrap.Popover(this, {
          sanitize: false,
          html: true,
          trigger: "manual",
          placement: this.dataset.bsPlacement || "left",
          // content is now read from data-bs-content attribute
        });
        if (currentButtonHovered === this) {
          // Only show if mouse is still over this button
          finalPopover.show();
          if (
            typeof feather !== "undefined" &&
            this.getAttribute("data-bs-content").includes("data-feather")
          ) {
            setTimeout(() => {
              const popoverElement = document.getElementById(
                this.getAttribute("aria-describedby")
              );
              if (popoverElement) {
                feather.replace({ class: "feather-sm", width: 14, height: 14 });
              }
            }, 50); // Small delay for DOM to update
          }
        } else {
          finalPopover.dispose(); // If mouse left quickly, don't show and clean up
        }
      });

      button.addEventListener("mouseleave", function () {
        currentButtonHovered = null; // Clear the currently hovered button
        // Use a timeout to allow mouse to move to popover
        setTimeout(() => {
          const popoverInstance = bootstrap.Popover.getInstance(this);
          if (popoverInstance) {
            const popoverElement = document.getElementById(
              this.getAttribute("aria-describedby")
            );
            const isMouseOverButton = this.matches(":hover");
            const isMouseOverPopover = popoverElement
              ? popoverElement.matches(":hover")
              : false;

            if (!isMouseOverButton && !isMouseOverPopover) {
              popoverInstance.hide(); // Or dispose if you prefer: popoverInstance.dispose();
            }
          }
        }, 150);
      });

      // Listener for when popover is created and shown, to handle mouseleave from popover itself
      button.addEventListener("shown.bs.popover", function () {
        const popoverElement = document.getElementById(
          this.getAttribute("aria-describedby")
        );
        if (popoverElement) {
          popoverElement.addEventListener("mouseleave", (event) => {
            // Check if mouse is now over the original button or if button is still the 'currentButtonHovered'
            if (!button.matches(":hover") && currentButtonHovered !== button) {
              const popoverInstance = bootstrap.Popover.getInstance(button);
              if (popoverInstance) {
                popoverInstance.hide(); // Or dispose: popoverInstance.dispose();
              }
            }
          });
        }
      });
    });

    // --- Start: Update Status Modal JavaScript (List Page) ---

    // Toast Notification Helper Function
    function showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            console.error('Toast container not found.');
            alert(`${type.toUpperCase()}: ${message}`);
            return;
        }
        const toastId = 'toast-' + Date.now();
        let bgColorClass = 'bg-info'; let iconName = 'info';
        if (type.toLowerCase() === 'success') { bgColorClass = 'bg-success'; iconName = 'check-circle'; }
        else if (type.toLowerCase() === 'error') { bgColorClass = 'bg-danger'; iconName = 'alert-triangle'; }
        else if (type.toLowerCase() === 'warning') { bgColorClass = 'bg-warning'; iconName = 'alert-circle'; }

        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgColorClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body"><i data-feather="${iconName}" class="me-2"></i> ${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>`;
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = document.getElementById(toastId);
        const bsToast = new bootstrap.Toast(toastElement, { delay: 5000 });
        if (typeof feather !== 'undefined') { feather.replace(); } // Make sure new feather icons in toasts are rendered
        bsToast.show();
        toastElement.addEventListener('hidden.bs.toast', function () { toastElement.remove(); });
    }

    const updateStatusModalElementList = document.getElementById('updateStatusModalList');
    if (updateStatusModalElementList) {
        const updateStatusModalList = new bootstrap.Modal(updateStatusModalElementList);
        const updateStatusFormList = document.getElementById('updateStatusFormList');
        const newStatusSelectList = document.getElementById('newStatusSelectList');
        const statusUpdateErrorAlertList = document.getElementById('statusUpdateErrorAlertList');
        const modalOrderPkInputList = document.getElementById('modalOrderPkInputList');
        const modalOrderNumberSpanList = document.getElementById('modalOrderNumberSpanList');

        updateStatusModalElementList.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const orderPk = button.getAttribute('data-order-pk');
            const orderNumber = button.getAttribute('data-order-number');
            const currentStatus = button.getAttribute('data-current-status');
            const deliveryType = button.getAttribute('data-delivery-type');

            if(modalOrderNumberSpanList) modalOrderNumberSpanList.textContent = orderNumber;
            if(modalOrderPkInputList) modalOrderPkInputList.value = orderPk;
            
            newStatusSelectList.innerHTML = ''; // Clear previous options
            statusUpdateErrorAlertList.classList.add('d-none');
            statusUpdateErrorAlertList.textContent = '';

            try {
                // IMPORTANT: {{ status_choices_json|safe }} must be available in the context for order_list.html
                const statusChoices = {% if status_choices_json %}{{ status_choices_json|safe }}{% else %}[]{% endif %};

                if (Array.isArray(statusChoices)) {
                    statusChoices.forEach(choice => {
                        const option = document.createElement('option');
                        option.value = choice.value;
                        option.textContent = choice.display;
                        if (choice.value === currentStatus) {
                            option.selected = true;
                        }
                        // Skip "Out for Delivery" for "Pickup" orders
                        if (deliveryType === 'Pickup' && choice.value === 'Out for Delivery') {
                            return; 
                        }
                        newStatusSelectList.appendChild(option);
                    });
                } else {
                    console.error('status_choices_json (list page) is not an array or is malformed:', statusChoices);
                    statusUpdateErrorAlertList.textContent = 'Error: Could not load status options.';
                    statusUpdateErrorAlertList.classList.remove('d-none');
                }
            } catch (e) {
                console.error('Error parsing status_choices_json (list page):', e);
                statusUpdateErrorAlertList.textContent = 'Error: Could not parse status options data.';
                statusUpdateErrorAlertList.classList.remove('d-none');
            }
        });

        updateStatusFormList.addEventListener('submit', function (event) {
            event.preventDefault();
            statusUpdateErrorAlertList.classList.add('d-none');
            statusUpdateErrorAlertList.textContent = '';

            const orderPk = modalOrderPkInputList.value;
            const selectedStatusValue = newStatusSelectList.value;
            const csrfTokenInput = this.querySelector('input[name="csrfmiddlewaretoken"]');
            if (!csrfTokenInput) {
                console.error('CSRF token input not found in modal form.');
                statusUpdateErrorAlertList.textContent = 'Error: Missing security token.';
                statusUpdateErrorAlertList.classList.remove('d-none');
                return;
            }
            const csrfToken = csrfTokenInput.value;
            const submitButton = document.getElementById('submitStatusUpdateBtnList');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
            
            // Retrieve the order_number from the modal's title span (already populated from button's data-order-number)
            const orderNumberForUrl = modalOrderNumberSpanList.textContent; 
            
            // Define a base URL template using the Django url tag with a placeholder
            // Note: "000_ORDER_NUMBER_PLACEHOLDER_000" is a unique placeholder string.
            const baseUrlForUpdate = "{% url 'orders:ajax_order_status_update' order_number="000_ORDER_NUMBER_PLACEHOLDER_000" %}"; 
            
            // Replace the placeholder with the actual order number
            let updateUrl = baseUrlForUpdate.replace("000_ORDER_NUMBER_PLACEHOLDER_000", orderNumberForUrl);

            $.ajax({
                url: updateUrl,
                type: 'POST',
                data: {
                    'status': selectedStatusValue,
                    'csrfmiddlewaretoken': csrfToken
                },
                success: function (response) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                    if (response.success) {
                        showToast(response.message || 'Order status updated successfully!', 'success');
                        updateStatusModalList.hide();
                        
                        // Update the status badge in the table
                        const row = document.querySelector(`button.update-status-btn-list[data-order-pk="${orderPk}"]`)?.closest('tr');
                        if (row) {
                            const statusBadgeContainer = row.querySelector('td:nth-child(3)'); // 3rd column for status
                            if (statusBadgeContainer && response.new_status_badge_html) {
                                statusBadgeContainer.innerHTML = response.new_status_badge_html;
                            } else if (statusBadgeContainer && response.new_status_display) { // Fallback if new_status_badge_html is not sent
                                 // Basic update if specific badge HTML isn't provided by server
                                 let newBadgeHtml = `<span class="badge py-2 px-3 bg-secondary">${response.new_status_display}</span>`; // Default/fallback
                                 // You might want to replicate the logic from the template for status-specific classes
                                 // For simplicity, this example uses a generic badge or relies on server sending full HTML
                                 if (response.new_status_value === "Pending") newBadgeHtml = `<span class="badge status-pending py-2 px-3">${response.new_status_display}</span>`;
                                 else if (response.new_status_value === "Accepted") newBadgeHtml = `<span class="badge status-confirmed py-2 px-3">${response.new_status_display}</span>`;
                                 else if (response.new_status_value === "Ready") newBadgeHtml = `<span class="badge status-ready py-2 px-3">${response.new_status_display}</span>`;
                                 else if (response.new_status_value === "Out for Delivery") newBadgeHtml = `<span class="badge status-processing py-2 px-3">${response.new_status_display}</span>`;
                                 else if (response.new_status_value === "Fulfilled") newBadgeHtml = `<span class="badge status-delivered py-2 px-3">${response.new_status_display}</span>`;
                                 else if (response.new_status_value === "Cancelled") newBadgeHtml = `<span class="badge status-cancelled py-2 px-3">${response.new_status_display}</span>`;
                                 statusBadgeContainer.innerHTML = newBadgeHtml;
                            }
                            // Update the button's data-current-status attribute
                            const updateButton = row.querySelector(`button.update-status-btn-list[data-order-pk="${orderPk}"]`);
                            if (updateButton && response.new_status_value) {
                                updateButton.setAttribute('data-current-status', response.new_status_value);
                            }
                        }
                    } else {
                        statusUpdateErrorAlertList.textContent = response.error || 'Failed to update status. Please try again.';
                        statusUpdateErrorAlertList.classList.remove('d-none');
                        showToast(response.error || 'Failed to update status.', 'error');
                    }
                },
                error: function (xhr) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                    let errorMsg = 'An error occurred. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    } else if (xhr.responseText) {
                        try {
                            const parsedError = JSON.parse(xhr.responseText);
                            if(parsedError && parsedError.error) errorMsg = parsedError.error;
                        } catch(e) { /* ignore parsing error, use default */ }
                    }
                    statusUpdateErrorAlertList.textContent = errorMsg;
                    statusUpdateErrorAlertList.classList.remove('d-none');
                    showToast(errorMsg, 'error');
                }
            });
        });
    }
    // --- End: Update Status Modal JavaScript (List Page) ---

    if (typeof feather !== "undefined") {
      feather.replace({ width: '1em', height: '1em', 'stroke-width': 2 });
    }
  });
</script>
{% endblock extra_js %}
