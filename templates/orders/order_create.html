{% extends "orders/base.html" %}
{% load orders_extras %}

{% block extra_css %}
{{ block.super }}
{% endblock %}

{% block orders_content %}
<!-- Page Header -->
<div class="page-header card shadow-sm">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-auto">
                <div class="page-icon-box">
                    <i data-feather="plus-circle"></i>
                </div>
            </div>
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}" class="text-decoration-none">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'orders:order_list' %}" class="text-decoration-none">Orders</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Create Order</li>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title h3 mb-0">{{ title }}</h1>
                        <p class="text-muted mb-0">Create a new order for a customer</p>
                    </div>
                    <div class="page-actions">
                        <a href="{% url 'orders:order_list' %}" class="btn btn-secondary">
                            <i data-feather="arrow-left" class="me-2"></i>Back to Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form method="post" id="order-form">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
    <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
            {{ error }}
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Customer Information Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i data-feather="user" class="me-2"></i>Customer Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Customer Name Field -->
                <div class="col-md-6 mb-3">
                    <label for="{{ form.customer_name.id_for_label }}" class="form-label required-field">
                        Customer Name
                    </label>
                    {{ form.customer_name }}
                    {% if form.customer_name.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.customer_name.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Phone Number Field -->
                <div class="col-md-6 mb-3">
                    <label for="{{ form.customer_phone.id_for_label }}" class="form-label required-field">
                        Phone Number
                    </label>
                    {{ form.customer_phone }}
                    {% if form.customer_phone.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.customer_phone.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="text-muted">Ghanaian format: +233XXXXXXXXX or 0XXXXXXXXX</small>
                </div>
                
                <!-- Delivery Type Field -->
                <div class="col-md-6 mb-3">
                    <label for="{{ form.delivery_type.id_for_label }}" class="form-label required-field">
                        Delivery Type
                    </label>
                    {{ form.delivery_type }}
                    {% if form.delivery_type.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.delivery_type.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Delivery Location Field (conditionally displayed) -->
                <div class="col-md-6 mb-3" id="delivery-location-container">
                    <label for="{{ form.delivery_location.id_for_label }}" class="form-label" id="location-label">
                        Delivery Location
                    </label>
                    {{ form.delivery_location }}
                    {% if form.delivery_location.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.delivery_location.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="text-muted">Required for delivery orders</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Items Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i data-feather="shopping-cart" class="me-2"></i>Order Items
            </h5>
        </div>
        <div class="card-body">
            <!-- Order Items Formset -->
            {{ formset.management_form }}

            {% if formset.non_form_errors %}
                <div class="alert alert-danger mt-2">
                    <strong>Please correct the following general item errors:</strong>
                    <ul class="mb-0 ms-3">
                    {% for error in formset.non_form_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if formset_is_bound %} {# Only show detailed item_form errors if form was submitted #}
                {% for item_form in formset %}
                    {% if item_form.errors %}
                        <div class="alert alert-warning mt-2">
                            <strong>Item {{ forloop.counter }} has errors:</strong>
                            <ul class="mb-0 ms-3">
                            {% for field, field_errors in item_form.errors.items %}
                                <li>
                                    <span class="text-capitalize">{{ field|replace:"_, "|default:"Error" }}</span>:
                                    {% for error in field_errors %}{{ error }}{% endfor %}
                                </li>
                            {% endfor %}
                            {% for error in item_form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            <div id="order-items">
                <!-- Items will be added here dynamically by JavaScript -->
            </div>
            
            <!-- Hidden template for menu options - pre-rendered by Django -->
            <div id="menu-template" style="display: none;">
                <select>
                    <option value="">-- Select a menu item --</option>
                    {% for group, options in formset.empty_form.fields.menu_item.choices %}
                        <optgroup label="{{ group }}">
                            {% for value, label in options %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Add Item Button -->
            <div class="d-flex justify-content-end align-items-center border-bottom pb-4 mb-4">
                <button type="button" id="add-item" class="btn btn-primary">
                    <i data-feather="plus-circle" class="me-2"></i>Add Item
                </button>
            </div>

            <!-- Order Totals -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 offset-md-2">
                            <table class="table table-borderless mb-0">
                                <tr>
                                    <td>Items Subtotal:</td>
                                    <td class="text-end price-display" id="items-subtotal">₵0.00</td> {# JS will update this #}
                                </tr>
                                <tr>
                                    <td>Delivery Fee:</td>
                                    <td class="text-end price-display" id="delivery-fee-display">₵{% if form.instance.pk %}{{ form.instance.delivery_fee|floatformat:2 }}{% else %}0.00{% endif %}</td> {# Shows saved/default fee #}
                                </tr>
                                <tr class="table-light fw-bold">
                                    <th>Grand Total:</th>
                                    <th class="text-end price-display" id="grand-total-display">₵{% if form.instance.pk %}{{ form.instance.total_price|floatformat:2 }}{% else %}0.00{% endif %}</th> {# Shows saved/default total #}
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Hidden fields -->
            <div class="d-none">
                {{ form.status }}
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'orders:order_list' %}" class="btn btn-secondary">
                    <i data-feather="x" class="me-2"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i data-feather="check" class="me-2"></i>Create Order
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ available_extras_data|json_script:"available-extras-data" }}
{{ DELIVERY_FEES|json_script:"delivery-fees-data" }}
<script>
document.addEventListener('DOMContentLoaded', function() {
        let AVAILABLE_EXTRAS = [];
        try {
            const jsonDataElement = document.getElementById('available-extras-data');
            if (jsonDataElement) {
                AVAILABLE_EXTRAS = JSON.parse(jsonDataElement.textContent);
            } else {
                console.warn("JSON data script #available-extras-data not found. Extras functionality may be limited.");
            }
        } catch (e) {
            console.error("Error parsing AVAILABLE_EXTRAS data from #available-extras-data:", e);
        }

        // Improved menu options caching
        let cachedMenuOptionsHTML = '';
        let initializationAttempts = 0;
        const MAX_INIT_ATTEMPTS = 3;

        // Function to get menu options HTML with improved error handling
        function getMenuOptionsHTML() {
            const fallbackOptionHTML = '<option value="">-- Select a menu item --</option>';
            // Attempt to cache if cache is empty OR if it only contains the fallback placeholder
            if (!cachedMenuOptionsHTML || cachedMenuOptionsHTML.trim() === fallbackOptionHTML.trim()) {
                const menuTemplate = document.getElementById('menu-template');
                if (menuTemplate && menuTemplate.querySelector('select')) {
                    const selectElement = menuTemplate.querySelector('select');
                    // Check if the template actually contains more than just the placeholder
                    if (selectElement.innerHTML.trim() && selectElement.innerHTML.trim() !== fallbackOptionHTML.trim() && selectElement.options.length > 1) {
                        cachedMenuOptionsHTML = selectElement.innerHTML;
                    } else {
                        console.warn("Menu template #menu-template found, but seems empty or only contains a placeholder. Using fallback for menu options.");
                        cachedMenuOptionsHTML = fallbackOptionHTML; // Cache the fallback
                    }
                } else {
                    console.error("Menu template #menu-template not found or is invalid. Using fallback for menu options.");
                    cachedMenuOptionsHTML = fallbackOptionHTML; // Cache the fallback
                }
            }
            return cachedMenuOptionsHTML;
        }

        // Initialize menu options cache immediately
        getMenuOptionsHTML();

        // Enhanced initialization function that handles both new and existing orders
        function initializeOrderItems() {
            const orderItemsContainer = document.getElementById('order-items');
            const totalFormsInput = document.querySelector('[name="items-TOTAL_FORMS"]');
            
            if (!orderItemsContainer || !totalFormsInput) {
                console.error("Required elements not found");
                if (initializationAttempts < MAX_INIT_ATTEMPTS) {
                    initializationAttempts++;
                    setTimeout(initializeOrderItems, 100);
                }
                return;
            }

            try {
                // Check if this is an existing order
                const existingItems = orderItemsContainer.querySelectorAll('.item-row');
                
                if (existingItems.length > 0) {
                    // Initialize existing items
                    existingItems.forEach(item => initializeItem(item));
                } else {
                    // Create initial item for new order
                    const newItem = createItemTemplate(0);
                    const addItemButton = document.getElementById('add-item'); // Get button for potential disabling

                    if (newItem) {
                        orderItemsContainer.appendChild(newItem);
                        initializeItem(newItem);
                        totalFormsInput.value = '1';
                        if (addItemButton) { // Ensure button text is updated if item is added
                             addItemButton.innerHTML = '<i data-feather="plus-circle" class="me-2"></i>Add Another Item';
                             feather.replace();
                        }
                    } else {
                        // createItemTemplate returned null, meaning no menu options
                        console.warn("Initial item creation failed (createItemTemplate returned null), likely no menu items available.");
                        totalFormsInput.value = '0'; // No items added initially
                        if (orderItemsContainer) {
                            orderItemsContainer.innerHTML = `
                                <div class="alert alert-warning" role="alert">
                                    <strong>No menu items available.</strong> Cannot add items to the order. 
                                    Please ensure 'regular' menu items are available in the system.
                                </div>`;
                        }
                        if (addItemButton) {
                            addItemButton.disabled = true;
                            addItemButton.innerHTML = '<i data-feather="slash" class="me-2"></i>No Items Available';
                            feather.replace();
                            // Optionally change style to indicate disabled state more clearly
                            addItemButton.classList.remove('btn-primary');
                            addItemButton.classList.add('btn-secondary');
                        }
                    }
                }

                // Initial totals calculation
                updateTotals();
            } catch (error) {
                console.error("Error during initialization:", error);
                if (initializationAttempts < MAX_INIT_ATTEMPTS) {
                    initializationAttempts++;
                    setTimeout(initializeOrderItems, 100);
                }
            }
        }

        // Start initialization with a short delay
        setTimeout(initializeOrderItems, 100);
        
        // Single price update function
        function updateItemPrice(item) {
            const select = item.querySelector('select[name*="menu_item"]');
            const priceDisplay = item.querySelector('.item-price');
            const unitPriceInput = item.querySelector('[name$="-unit_price"]');
            
            if (!select || !priceDisplay) {
                console.warn("Required elements not found for price update");
                return;
            }
            
            // Ensure we have a selected option
            if (select.selectedIndex === -1 && select.options.length > 0) {
                // Find first valid option
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value) {
                        select.selectedIndex = i;
                        break;
                    }
                }
            }
            
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.text) {
                // Extract price with improved pattern matching
                let price = null;
                
                // Try to extract price with various patterns
                const patterns = [
                    // Ghana cedis formats
                    /₵\s*(\d+\.?\d*)/,                   // ₵10.99
                    /\(\s*₵\s*(\d+\.?\d*)\s*\)/,         // (₵10.99)
                    
                    // Dollar formats (for backward compatibility)
                    /\$\s*(\d+\.?\d*)/,                  // $10.99
                    /\(\s*\$\s*(\d+\.?\d*)\s*\)/,        // ($10.99)
                    
                    // Generic number pattern as last resort
                    /[^\d](\d+\.\d+)[^\d]/,              // price: 10.99
                    /(\d+\.\d+)/                         // just get any decimal number
                ];
                
                // Try each pattern until we find a match
                for (const pattern of patterns) {
                    const match = selectedOption.text.match(pattern);
                    if (match && match[1]) {
                        price = parseFloat(match[1]);
                        break;
                    }
                }
                
                if (price !== null) {
                    // Format with exactly 2 decimal places
                    const formattedPrice = price.toFixed(2);
                    
                    // Update display price
                    priceDisplay.value = '₵' + formattedPrice;
                    
                    // Update hidden input for form submission
                    if (unitPriceInput) {
                        unitPriceInput.value = formattedPrice;
                    }
                    
                    // Trigger totals update
                    updateTotals();
                    return;
                } else {
                    console.warn(`No price found in text: "${selectedOption.text}"`);
                }
            } else {
                console.warn("No selected option or option text available");
            }
            
            // Default values if no price found
            priceDisplay.value = '₵0.00';
            if (unitPriceInput) {
                unitPriceInput.value = '0.00';
            }
            
            // Update totals even if price is 0
            updateTotals();
        }

        function updateTotals() {
            let itemsSubtotalOnly = 0; // Renamed for clarity
            document.querySelectorAll('.item-row:not([style*="display: none"])').forEach((item, index) => {
                const priceDisplay = item.querySelector('.item-price');
                const unitPriceInput = item.querySelector('[name$="-unit_price"]');
                const quantityInput = item.querySelector('.quantity-input');
                
                if (quantityInput) {
                    let price = 0;
                    if (unitPriceInput && unitPriceInput.value) {
                        price = parseFloat(unitPriceInput.value) || 0;
                    } else if (priceDisplay) {
                        price = parseFloat(priceDisplay.value.replace(/[₵$]/g, '')) || 0; // Allow for $ or ₵
                    }
                    
                    const quantity = parseInt(quantityInput.value) || 0;
                    const itemTotal = price * quantity;
                    itemsSubtotalOnly += itemTotal;
                }
            });
            
            const itemsSubtotalDisplayElement = document.getElementById('items-subtotal');
            const deliveryFeeDisplayElement = document.getElementById('delivery-fee-display');
            const grandTotalDisplayElement = document.getElementById('grand-total-display'); // Corrected ID
            
            if (itemsSubtotalDisplayElement) {
                itemsSubtotalDisplayElement.textContent = '₵' + itemsSubtotalOnly.toFixed(2);
            }

            let deliveryFee = 0;
            if (deliveryFeeDisplayElement) {
                const feeText = deliveryFeeDisplayElement.textContent.replace(/[^0-9.]/g, ''); 
                if (feeText) {
                    deliveryFee = parseFloat(feeText);
                    if (isNaN(deliveryFee)) deliveryFee = 0;
                }
            }
            
            const grandTotal = itemsSubtotalOnly + deliveryFee;

            if (grandTotalDisplayElement) { 
                grandTotalDisplayElement.textContent = '₵' + grandTotal.toFixed(2);
            }
        }

        // Update element attributes for new items
        function updateElementAttributes(element, index) {
            element.querySelectorAll('[name], [id], label[for]').forEach(el => {
                if (el.hasAttribute('name')) {
                    el.name = el.name.replace(/\d+/, index);
                }
                if (el.id && el.id.includes('-')) {
                    el.id = el.id.replace(/\d+/, index);
                }
                if (el.tagName === 'LABEL' && el.getAttribute('for')) {
                    el.setAttribute('for', el.getAttribute('for').replace(/\d+/, index));
                }
            });
        }

        // Initialize single item with improved error handling
        function initializeItem(item) {
            try { // Add try here
                const select = item.querySelector('select[name*="menu_item"]');
                const quantityInput = item.querySelector('.quantity-input');
                
                if (select) {
                    // Ensure menu options are properly set
                    if (!select.options.length) { // If options are missing (e.g. new row)
                        select.innerHTML = getMenuOptionsHTML();
                    }
                    // Diagnostic check from previous step
                    if (select && select.options.length <= 1) { 
                        if (select.options.length === 0 || (select.options.length === 1 && !select.options[0].value && select.options[0].text.includes("-- Select"))) {
                             console.error(`Item ${item.id || 'new_item'}: Menu item select dropdown appears empty or only has a placeholder after initialization from getMenuOptionsHTML(). Check #menu-template content and OrderItemForm choices.`);
                        }
                    }
                    
                    // Handle initial selection
                    if (select.selectedIndex === -1) {
                        for (let i = 0; i < select.options.length; i++) {
                            if (select.options[i].value) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    updateItemPrice(item); // Update price
                    select.addEventListener('change', () => { // Add change listener
                        updateItemPrice(item);
                    });
                }

                if (quantityInput) {
                    quantityInput.addEventListener('change', () => {
                        updateTotals();
                    });
                }

                const removeButton = item.querySelector('.remove-item');
                if (removeButton) {
                    removeButton.addEventListener('click', () => {
                        const deleteCheckbox = item.querySelector('[name$="-DELETE"]');
                        if (deleteCheckbox) {
                            deleteCheckbox.checked = true;
                            item.style.display = 'none';
                            updateTotals();
                            
                            const visibleItems = document.querySelectorAll('.item-row:not([style*="display: none"])');
                            const addItemButton = document.getElementById('add-item');
                            if (visibleItems.length === 0 && addItemButton) {
                                addItemButton.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add Item';
                            }
                        }
                    });
                }
            } catch (e) { // Add catch here
                console.error(`Error during initializeItem for item with id "${item ? item.id : 'undefined'}":`, e);
                // Optionally, you could add an alert here too, or disable further interactions if an item fails to init.
                // For now, logging to console is the primary goal.
                // Example: alert(`Critical error initializing item ${item ? item.id : 'unknown'}. Please check console.`);
            }
        }

        // Remove this block as we now use the getMenuOptionsHTML function for caching
        // and accessing menu options

        // Create a new order item from template
        function createItemTemplate(index) {
            // Get menu options from our cached function
            const menuOptionsHtml = getMenuOptionsHTML();
            const fallbackOptionHTML = '<option value="">-- Select a menu item --</option>';
            if (!menuOptionsHtml || menuOptionsHtml.trim() === fallbackOptionHTML.trim() || menuOptionsHtml.trim() === '') {
                console.error(`[createItemTemplate] For item index ${index}: getMenuOptionsHTML() returned empty or only placeholder options. This likely means the #menu-template in the HTML is not being populated correctly by Django's formset.empty_form.fields.menu_item.choices, possibly because no 'regular' menu items are available in the database or the OrderItemForm is not correctly configured. Cannot create a new item row without menu options.`);
                return null; // Explicitly return null
            }
            
            try {
                // Create the full item HTML
                const html = `
                    <div class="item-row card shadow-sm mb-3" id="item-${index}">
                        <div class="card-body">
                            <div class="row">
                                <!-- Item Selection -->
                                <div class="col-md-6">
                                    <label class="form-label required-field">Menu Item</label>
                                    <select name="items-${index}-menu_item" class="form-select menu-item-select" required>
                                        ${menuOptionsHtml}
                                    </select>
                                </div>
                                
                                <!-- Quantity -->
                                <div class="col-md-2">
                                    <label class="form-label required-field">Quantity</label>
                                    <input type="number" name="items-${index}-quantity" class="form-control quantity-input" min="1" value="1" required>
                                </div>
                                
                                <!-- Item Price Display -->
                                <div class="col-md-2">
                                    <label class="form-label">Unit Price</label>
                                    <input type="text" class="form-control item-price" readonly value="₵0.00">
                                    <!-- Hidden unit price field for form submission -->
                                    <input type="hidden" name="items-${index}-unit_price" value="0.00">
                                </div>
                                
                                <!-- Remove Button -->
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger mb-3 remove-item">
                                        <i data-feather="trash-2"></i>
                                    </button>
                                    <input type="checkbox" name="items-${index}-DELETE" class="d-none">
                                    <input type="hidden" name="items-${index}-id" value="">
                                    <input type="hidden" name="items-${index}-order" value="">
                                </div>
                            </div> <!-- End of row for item details -->

                            <!-- New block for Add Extra button and its container -->
                            <div class="row mt-2">
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-sm btn-success add-extra-btn" data-item-prefix="items-${index}">
                                        <i data-feather="plus"></i> Add Extra
                                    </button>
                                </div>
                            </div>
                            <div class="extras-container mt-2" id="extras-container-for-${index}">
                                <!-- Extras for this item will be appended here by JavaScript -->
                            </div>
                            <!-- End of new block -->
                        </div>
                    </div>
                `;
                
                // Create DOM element from HTML
                const container = document.createElement('div');
                container.innerHTML = html.trim();
                return container.firstChild;
            } catch (error) {
                console.error("Error creating item template:", error);
                return null;
            }
        }

        function createExtraRowHTML(formsetIndex, extraMenuItem, parentItemFormPrefix) {
            // Ensure price is a number and formatted
            const price = parseFloat(extraMenuItem.price) || 0;
            const formattedPrice = price.toFixed(2);

            const html = `
                <div class="item-row extra-item-row card shadow-sm mb-2 ms-4" id="item-${formsetIndex}">
                    <div class="card-body p-2">
                        <input type="hidden" name="items-${formsetIndex}-menu_item" value="${extraMenuItem.id}">
                        <input type="hidden" name="items-${formsetIndex}-parent_item_ref" value="${parentItemFormPrefix}">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <small class="text-muted"><i data-feather="corner-down-right" class="me-1"></i> Extra:</small>
                                <strong>${extraMenuItem.name}</strong>
                            </div>
                            <div class="col-md-2">
                                <label for="items-${formsetIndex}-quantity" class="visually-hidden">Quantity for ${extraMenuItem.name}</label>
                                <input type="number" name="items-${formsetIndex}-quantity" id="items-${formsetIndex}-quantity" class="form-control form-control-sm quantity-input extra-quantity-input" min="1" value="1" required>
                            </div>
                            <div class="col-md-3">
                                <label for="items-${formsetIndex}-price_display_extra" class="visually-hidden">Price for ${extraMenuItem.name}</label>
                                <input type="text" id="items-${formsetIndex}-price_display_extra" class="form-control form-control-sm item-price extra-item-price" readonly value="₵${formattedPrice}">
                                <input type="hidden" name="items-${formsetIndex}-unit_price" class="unit-price-input" value="${formattedPrice}">
                            </div>
                            <div class="col-md-3 d-flex align-items-center justify-content-end">
                                <button type="button" class="btn btn-sm btn-danger remove-item remove-extra-btn">
                                    <i data-feather="x"></i>
                                </button>
                                <input type="checkbox" name="items-${formsetIndex}-DELETE" id="items-${formsetIndex}-DELETE" class="d-none">
                                <input type="hidden" name="items-${formsetIndex}-id" id="items-${formsetIndex}-id" value="">
                                <input type="hidden" name="items-${formsetIndex}-order" id="items-${formsetIndex}-order" value="">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.createElement('div'); // Create a temporary container
            container.innerHTML = html.trim();
            return container.firstChild; // Return the actual item row element
        }

        // Place this function after createExtraRowHTML
        function initializeExtraRow(extraRowElement) {
            const quantityInput = extraRowElement.querySelector('.extra-quantity-input'); // Use specific class if needed
            const removeButton = extraRowElement.querySelector('.remove-extra-btn'); // Use specific class
            const unitPriceInput = extraRowElement.querySelector('.unit-price-input'); // Hidden unit price

            if (!quantityInput || !removeButton || !unitPriceInput) {
                console.error('[initializeExtraRow] Essential elements missing in extra row:', extraRowElement);
                return;
            }

            // Event listener for quantity change
            quantityInput.addEventListener('input', function() { // 'input' for immediate response
                updateTotals();
            });

            // Event listener for remove button
            removeButton.addEventListener('click', function() {
                const deleteCheckbox = extraRowElement.querySelector('input[name$="-DELETE"]');
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    extraRowElement.style.display = 'none'; // Hide the row
                    updateTotals();
                } else {
                    // If it's a newly added row not yet part of a saved formset, 
                    // and no DELETE checkbox exists (e.g. if template was different)
                    // we might remove it from DOM directly. But standard formset practice uses DELETE.
                    console.warn('[initializeExtraRow] DELETE checkbox not found for extra row:', extraRowElement.id);
                }
            });
        }

        const orderItemsContainerForExtras = document.getElementById('order-items');

        if (orderItemsContainerForExtras) {
            orderItemsContainerForExtras.addEventListener('click', function(event) {
                if (event.target.classList.contains('add-extra-btn') || event.target.closest('.add-extra-btn')) {
                    event.preventDefault();
                    const addExtraButton = event.target.closest('.add-extra-btn');
                    const regularItemRow = addExtraButton.closest('.item-row');
                    if (!regularItemRow) return;

                    // const parentItemIndexMatch = regularItemRow.id.match(/item-(\d+)/);
                    // if (!parentItemIndexMatch) return; // Not strictly needed if we use querySelector below

                    const extrasContainer = regularItemRow.querySelector('.extras-container');
                    if (!extrasContainer) {
                        console.error("Extras container not found for item:", regularItemRow.id);
                        return;
                    }

                    // Remove any existing temporary extra selectors for this item
                    const existingTempSelector = extrasContainer.querySelector('.temp-extra-selector-ui');
                    if (existingTempSelector) {
                        existingTempSelector.remove();
                    }

                    // Create temporary UI for selecting an extra
                    const tempUI = document.createElement('div');
                    tempUI.className = 'temp-extra-selector-ui card card-body shadow-sm mt-2 p-2';
                    
                    let optionsHTML = '<option value="">-- Select an Extra --</option>';
                    AVAILABLE_EXTRAS.forEach(extra => {
                        optionsHTML += `<option value="${extra.id}" data-price="${parseFloat(extra.price).toFixed(2)}" data-name="${String(extra.name).replace(/"/g, '&quot;')}">${String(extra.name)} (₵${parseFloat(extra.price).toFixed(2)})</option>`;
                    });

                    tempUI.innerHTML = `
                        <div class="mb-2">
                            <select class="form-select form-select-sm dynamic-extra-select">${optionsHTML}</select>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-success confirm-add-selected-extra me-1">Add</button>
                            <button type="button" class="btn btn-sm btn-secondary cancel-add-selected-extra">Cancel</button>
                        </div>
                    `;
                    
                    extrasContainer.appendChild(tempUI); // Append inside the specific item's extras container

                    // Event listener for the dynamically created "Add" button for this specific temp UI
                    tempUI.querySelector('.confirm-add-selected-extra').addEventListener('click', function() {
                        const selectElement = tempUI.querySelector('.dynamic-extra-select');
                        const selectedOption = selectElement.options[selectElement.selectedIndex];

                        if (selectedOption && selectedOption.value) {
                            const extraId = selectedOption.value;
                            const extraPrice = selectedOption.getAttribute('data-price');
                            const extraName = selectedOption.getAttribute('data-name');
                            
                            const selectedExtraDetails = { id: extraId, name: extraName, price: extraPrice };

                            const totalFormsInput = document.querySelector('[name="items-TOTAL_FORMS"]');
                            const formsetIndex = parseInt(totalFormsInput.value);

                            const mainItemRowForExtra = tempUI.closest('.item-row:not(.extra-item-row)');
                            const parentItemFormPrefix = mainItemRowForExtra ? $(mainItemRowForExtra).find('.add-extra-btn').attr('data-item-prefix') : undefined;
                            if (!parentItemFormPrefix) {
                                console.error("Could not determine parentItemFormPrefix for new extra.");
                                // Optionally alert the user or handle the error
                            }

                            const newExtraRowElement = createExtraRowHTML(formsetIndex, selectedExtraDetails, parentItemFormPrefix);
                            extrasContainer.insertBefore(newExtraRowElement, tempUI); // Insert before the temp UI
                            feather.replace(); // Render newly added feather icon in extra row
                            initializeExtraRow(newExtraRowElement);

                            totalFormsInput.value = formsetIndex + 1;
                            updateTotals();
                            tempUI.remove(); // Remove temp UI after adding
                        } else {
                            alert("Please select an extra.");
                        }
                    });

                    // Event listener for the dynamically created "Cancel" button
                    tempUI.querySelector('.cancel-add-selected-extra').addEventListener('click', function() {
                        tempUI.remove();
                    });
                }
            });
        }

        // Initialize form elements
        const addItemButton = document.getElementById('add-item');
        const orderForm = document.querySelector('form');
        const deliveryTypeSelect = document.querySelector('select[name="delivery_type"]');

        // Add item button handler
        if (addItemButton) {
            addItemButton.addEventListener('click', () => {
                // Outer try-catch for the entire click handler logic
                try {
                    // Get total forms count
                    const totalFormsInput = document.querySelector('[name="items-TOTAL_FORMS"]');
                    if (!totalFormsInput) {
                        // This error was already being thrown by the inner try-catch,
                        // but explicitly checking earlier can be clearer.
                        console.error("Critical error: Total forms input '[name=\"items-TOTAL_FORMS\"]' not found.");
                        alert("A critical error occurred: Form management input is missing. Cannot add items.");
                        return;
                    }
                    
                    const newIndex = parseInt(totalFormsInput.value);
                    
                    const newItem = createItemTemplate(newIndex);
                    if (!newItem) {
                        console.error("Failed to create new item template, likely due to missing menu options. See previous error from createItemTemplate.");
                        alert("Cannot add new item: No menu items are available for selection, or there was an issue loading them. Please check console for details or ensure 'regular' menu items exist and are available.");
                        return; 
                    }
                    
                    const orderItemsContainer = document.getElementById('order-items');
                    if (!orderItemsContainer) {
                        console.error("Critical error: Order items container '#order-items' not found.");
                        alert("A critical error occurred: Order items container is missing. Cannot add items.");
                        return;
                    }
                    
                    orderItemsContainer.appendChild(newItem);
                    feather.replace(); // Render newly added feather icons in item row
                    
                    totalFormsInput.value = (newIndex + 1).toString();
                    
                    initializeItem(newItem); // This function now has its own internal try-catch
                    
                    // Ensure the button is enabled and text is correct if it wasn't disabled by initializeOrderItems
                    if (!addItemButton.disabled) {
                        addItemButton.innerHTML = '<i data-feather="plus-circle" class="me-2"></i>Add Another Item';
                        feather.replace(); // Render the icon in the button
                    }
                    
                    const menuSelect = newItem.querySelector('select[name*="menu_item"]');
                    if (menuSelect && menuSelect.options.length > 0) {
                        for (let i = 0; i < menuSelect.options.length; i++) {
                            if (menuSelect.options[i].value) {
                                menuSelect.selectedIndex = i;
                                break;
                            }
                        }
                        menuSelect.dispatchEvent(new Event('change'));
                    }
                    
                    updateTotals();
                    
                } catch (error) { // Catch errors from the main click handler logic
                    console.error("Error directly within addItemButton click handler:", error);
                    alert("An unexpected error occurred while trying to add the item. Please check the browser console for more details.");
                }
            });
        }

        // Form validation
        if (orderForm) {
            orderForm.addEventListener('submit', event => {
                try {
                    // Check for at least one visible item
                    const visibleItems = document.querySelectorAll('.item-row:not([style*="display: none"])');
                    if (visibleItems.length === 0) {
                        alert('Please add at least one item to the order.');
                        event.preventDefault();
                        return;
                    }
                    
                    // Validate each item
                    let isValid = true;
                    visibleItems.forEach((item, index) => {
                        // Validate menu item selection
                        const menuItemSelect = item.querySelector('select[name*="menu_item"]');
                        if (menuItemSelect && (!menuItemSelect.value || menuItemSelect.value === '')) {
                            menuItemSelect.classList.add('is-invalid');
                            isValid = false;
                        } else if (menuItemSelect) {
                            menuItemSelect.classList.remove('is-invalid');
                        }
                        
                        // Ensure unit price is set
                        const unitPriceInput = item.querySelector('[name$="-unit_price"]');
                        if (unitPriceInput && (!unitPriceInput.value || parseFloat(unitPriceInput.value) <= 0)) {
                            // Try to update price one more time
                            updateItemPrice(item);
                        }
                    });
                    
                    // Check delivery location if delivery type is selected
                    const deliveryTypeValue = deliveryTypeSelect ? deliveryTypeSelect.value : '';
                    const deliveryLocationInput = document.getElementById('id_delivery_location'); // Use ID selector
                    
                    if (deliveryTypeValue === 'Delivery' && deliveryLocationInput && !deliveryLocationInput.value.trim()) {
                        deliveryLocationInput.classList.add('is-invalid');
                        if (!document.querySelector('.invalid-feedback[data-for="delivery_location"]')) {
                            const feedback = document.createElement('div');
                            feedback.className = 'invalid-feedback d-block';
                            feedback.setAttribute('data-for', 'delivery_location');
                            feedback.textContent = 'Delivery location is required for delivery orders';
                            deliveryLocationInput.parentNode.appendChild(feedback);
                        }
                        isValid = false;
                    }
                    
                    if (!isValid) {
                        event.preventDefault();
                    }
                } catch (error) {
                    console.error("Error during form validation:", error);
                    // Don't prevent submission on validation error
                }
            });
        }

        let DELIVERY_FEES_JS = {};
        try {
            const deliveryFeesDataElement = document.getElementById('delivery-fees-data');
            if (deliveryFeesDataElement) {
                DELIVERY_FEES_JS = JSON.parse(deliveryFeesDataElement.textContent);
            } else {
                console.warn("Delivery fees data script #delivery-fees-data not found.");
            }
        } catch (e) {
            console.error("Error parsing DELIVERY_FEES_JS data:", e);
        }

        function updateDynamicDeliveryFeeAndTotals() {
            const deliveryTypeSelect = document.getElementById('id_delivery_type');
            const deliveryLocationSelect = document.getElementById('id_delivery_location');
            const deliveryFeeDisplay = document.getElementById('delivery-fee-display');

            if (!deliveryTypeSelect || !deliveryFeeDisplay) {
                console.warn("Delivery type select or fee display element not found for dynamic fee update.");
                return;
            }

            let calculatedFee = 0.00;
            const selectedDeliveryType = deliveryTypeSelect.value;

            if (selectedDeliveryType === 'Delivery') {
                if (deliveryLocationSelect) {
                    const selectedLocation = deliveryLocationSelect.value;
                    if (selectedLocation && DELIVERY_FEES_JS.hasOwnProperty(selectedLocation)) {
                        calculatedFee = parseFloat(DELIVERY_FEES_JS[selectedLocation]);
                    } else {
                        calculatedFee = 0.00; 
                    }
                }
            } else if (selectedDeliveryType === 'Pickup') {
                calculatedFee = 0.00;
            }

            if (isNaN(calculatedFee)) calculatedFee = 0.00;

            deliveryFeeDisplay.textContent = '₵' + calculatedFee.toFixed(2);
            
            if (typeof updateTotals === "function") {
                updateTotals();
            } else {
                console.warn("updateTotals function not found after updating delivery fee.");
            }
        }

        // --- BEGIN: Modified toggleLocationField logic ---
        function toggleLocationField(deliveryType) {
            const locationContainer = document.getElementById('delivery-location-container');
            const locationLabel = document.getElementById('location-label') || document.querySelector('label[for="id_delivery_location"]');
            const locationInput = document.getElementById('id_delivery_location'); 
            
            if (locationContainer && locationLabel && locationInput) {
                if (deliveryType === 'Delivery') {
                    locationContainer.style.display = 'block';
                    locationLabel.classList.add('required-field');
                    locationInput.required = true;
                } else {
                    locationContainer.style.display = 'none';
                    locationLabel.classList.remove('required-field');
                    locationInput.required = false;
                }
            }
            updateDynamicDeliveryFeeAndTotals(); // Call here
        }

        // Ensure deliveryTypeSelect is the one from the form, usually 'id_delivery_type'
        // const localDeliveryTypeSelect = document.querySelector('select[name="delivery_type"]'); // deliveryTypeSelect is already defined at this scope
        const deliveryTypeSelectForEvent = document.getElementById('id_delivery_type'); // Use ID for consistency
        const deliveryLocationSelectForEvent = document.getElementById('id_delivery_location');

        if (deliveryTypeSelectForEvent) { 
            toggleLocationField(deliveryTypeSelectForEvent.value); // Initial state check
            deliveryTypeSelectForEvent.addEventListener('change', function() {
                toggleLocationField(this.value); // This will also call updateDynamicDeliveryFeeAndTotals
            });
        }
        if (deliveryLocationSelectForEvent) {
            deliveryLocationSelectForEvent.addEventListener('change', updateDynamicDeliveryFeeAndTotals);
        }
        // --- END: Modified toggleLocationField and event listener logic ---

        // Initial totals calculation, which now implicitly includes delivery fee via updateDynamicDeliveryFeeAndTotals
        // updateTotals(); // Called by updateDynamicDeliveryFeeAndTotals, which is called by toggleLocationField
        // Explicit initial call to ensure fees are set if toggleLocationField didn't run or fully update
        updateDynamicDeliveryFeeAndTotals(); 

    });
</script>
{% endblock %}

